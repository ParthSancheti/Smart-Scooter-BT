<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#000000"> 
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Activa Smart Key</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* --- Base Setup --- */
        body {
            background-color: #000000;
            background-image: radial-gradient(circle at 50% 0%, #1e293b 0%, #000000 100%);
            min-height: 100vh;
            overflow: hidden; touch-action: none;
            font-family: 'Segoe UI', sans-serif;
            color: white;
            padding-top: calc(1rem + env(safe-area-inset-top));
        }

        /* --- Glassmorphism --- */
        .glass-card {
            background: rgba(20, 20, 20, 0.6);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.1);
            box-shadow: 0 20px 50px -10px rgba(0,0,0,0.7);
        }

        .glass-button {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .glass-button:active { transform: scale(0.96); background: rgba(255, 255, 255, 0.15); }

        /* --- KTM BOOT ANIMATIONS --- */
        #boot-screen {
            position: fixed; inset: 0; z-index: 9999;
            background: black;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            overflow: hidden;
            /* No transition on the container opacity, we animate the children */
        }

        .ktm-font {
            font-family: 'Impact', 'Arial Black', sans-serif; /* Heaviest fonts */
            text-transform: uppercase;
            font-style: italic;
            font-weight: 900; /* Maximum weight */
            line-height: 0.85;
            letter-spacing: -2px;
        }

        /* 1. Slide Animations (Entry) */
        .slide-left {
            transform: translateX(-150%) skewX(-12deg);
            opacity: 0;
            animation: slideInLeft 0.5s cubic-bezier(0.19, 1, 0.22, 1) forwards;
        }

        .slide-right {
            transform: translateX(150%) skewX(-12deg);
            opacity: 0;
            animation: slideInRight 0.5s cubic-bezier(0.19, 1, 0.22, 1) 0.3s forwards; /* 0.3s delay */
        }

        @keyframes slideInLeft {
            0% { transform: translateX(-150%) skewX(-20deg); opacity: 0; }
            100% { transform: translateX(0) skewX(-12deg); opacity: 1; }
        }

        @keyframes slideInRight {
            0% { transform: translateX(150%) skewX(-20deg); opacity: 0; }
            100% { transform: translateX(0) skewX(-12deg); opacity: 1; }
        }

        /* 2. The Super Zoom (Exit) */
        .zoom-n-fade {
            animation: superZoom 0.6s cubic-bezier(0.7, 0, 0.84, 0) forwards;
        }

        @keyframes superZoom {
            0% { transform: scale(1) skewX(-12deg); opacity: 1; }
            40% { opacity: 1; }
            100% { transform: scale(25) skewX(-12deg); opacity: 0; }
        }

        /* --- OTHER ANIMATIONS --- */
        .sonar-effect { animation: sonar 1.5s infinite; }
        @keyframes sonar {
            0% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0.7); }
            70% { box-shadow: 0 0 0 30px rgba(234, 179, 8, 0); }
            100% { box-shadow: 0 0 0 0 rgba(234, 179, 8, 0); }
        }

        .lock-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border-color: #ef4444 !important; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .engine-running {
            border-color: #22c55e !important;
            background: rgba(34, 197, 94, 0.15) !important;
            box-shadow: 0 0 30px rgba(34, 197, 94, 0.2);
        }

        .offline-ui { filter: grayscale(100%); opacity: 0.5; pointer-events: none; transition: all 0.5s ease; }
        
        .ripple-effect {
            position: absolute; border-radius: 50%;
            background: rgba(255, 255, 255, 0.4);
            transform: scale(0); animation: ripple 600ms linear; pointer-events: none;
        }
        @keyframes ripple { to { transform: scale(4); opacity: 0; } }
    </style>
</head>

<body class="flex flex-col items-center justify-center">

    <div id="boot-screen">
        <div id="boot-content" class="flex flex-col items-center justify-center space-y-1">
            <div class="ktm-font text-7xl text-gray-200 slide-left" id="ktm-ready">
                READY
            </div>
            
            <div class="flex items-center space-x-2 slide-right" id="ktm-race">
                <div class="ktm-font text-7xl text-[#ff6600]">
                    TO RACE
                </div>
                <i class="fa-solid fa-flag-checkered text-4xl text-white"></i>
            </div>
        </div>
    </div>

    <audio id="sound-boot" src="boot.mp3"></audio> 
    <audio id="sound-start" src="start.mp3"></audio>
    <audio id="sound-click" src="click.mp3"></audio>

    <button id="menu-btn" class="ripple-btn fixed top-4 left-4 p-3 rounded-full glass-card z-50 text-white"><i class="fa-solid fa-bars"></i></button>
    <a href="https://github.com/ParthSancheti" target="_blank" class="ripple-btn fixed top-4 right-4 p-3 rounded-full glass-card z-50 text-white"><i class="fa-brands fa-github"></i></a>

    <div id="floating-menu" class="hidden fixed top-16 left-4 w-60 glass-card rounded-2xl z-50 p-2">
        <button onclick="triggerBluetooth()" class="w-full p-3 text-left text-white hover:bg-white/10 rounded-lg">ðŸ”— Re-Scan Bluetooth</button>
        <div class="h-px bg-white/10 my-1"></div>
        <div class="p-3 text-xs text-gray-400">Status: <span id="menu-status" class="text-red-400 font-bold">Disconnected</span></div>
    </div>

    <div class="w-full max-w-sm px-4 relative z-10">
        
        <div class="flex justify-center mb-6 relative">
            <div id="bike-glow" class="absolute inset-0 rounded-full bg-yellow-500/0 blur-3xl transition-all duration-500"></div>
            <img id="main-bike-img" src="activa.png" class="w-56 object-contain drop-shadow-2xl relative z-10" alt="Activa">
        </div>

        <div id="main-ui" class="glass-card rounded-3xl p-6 w-full flex flex-col space-y-4">
            <div class="text-center mb-2">
                <h1 class="text-3xl font-bold italic tracking-tighter">ACTIVA <span class="text-orange-500">R</span></h1>
                <p id="main-status-text" class="text-gray-400 text-xs tracking-[0.2em] font-bold">SYSTEM OFFLINE</p>
            </div>

            <button onclick="toggleEngine()" id="btn-start" class="ripple-btn glass-button w-full p-4 rounded-xl flex items-center justify-between group opacity-50">
                <div class="flex items-center space-x-4">
                    <div id="icon-start" class="w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-xl transition-colors">
                        <i class="fa-solid fa-power-off"></i>
                    </div>
                    <div>
                        <h3 id="txt-start" class="font-bold text-lg">Ignition</h3>
                        <p id="sub-start" class="text-xs text-gray-400">Start Sequence</p>
                    </div>
                </div>
                <i class="fa-solid fa-chevron-right text-gray-500"></i>
            </button>

            <button onclick="findBike()" id="btn-find" class="ripple-btn glass-button w-full p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-full bg-yellow-500/20 flex items-center justify-center text-yellow-400 text-xl">
                        <i class="fa-solid fa-location-crosshairs"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">Locator</h3>
                        <p class="text-xs text-gray-400">Sonar Flash</p>
                    </div>
                </div>
            </button>

            <button onclick="toggleLock()" id="btn-lock" class="ripple-btn glass-button w-full p-4 rounded-xl flex items-center justify-between">
                <div class="flex items-center space-x-4">
                    <div class="w-12 h-12 rounded-full bg-red-500/20 flex items-center justify-center text-red-400 text-xl">
                        <i id="icon-lock" class="fa-solid fa-lock"></i>
                    </div>
                    <div>
                        <h3 class="font-bold text-lg">Secure</h3>
                        <p id="sub-lock" class="text-xs text-gray-400">System Locked</p>
                    </div>
                </div>
                <div id="dot-lock" class="w-3 h-3 rounded-full bg-green-500 shadow-[0_0_10px_#22c55e]"></div>
            </button>
        </div>
    </div>

    <script>
        /* --- LOGIC VARIABLES --- */
        let engineRunning = false;
        let isLocked = false;
        let isConnected = false; 
        let lastPacketTime = 0;
        
        // --- PRECISE BOOT SEQUENCE ---
        window.onload = function() {
            const bootScreen = document.getElementById('boot-screen');
            const bootContent = document.getElementById('boot-content');
            const bootSound = document.getElementById('sound-boot');

            // 1. "READY" slams in
            setTimeout(() => { 
                haptic(30); // Sharp tap
            }, 100);

            // 2. "TO RACE" slams in
            setTimeout(() => { 
                haptic(30); // Sharp tap
            }, 400);

            // 3. THE DROP (Zoom + Sound)
            setTimeout(() => {
                // Play song/sound here
                if(bootSound) {
                    bootSound.volume = 1.0;
                    bootSound.play().catch(e => console.log("Audio play failed (user interaction needed)"));
                }

                // Apply the Super Zoom class to the text container
                bootContent.classList.add('zoom-n-fade');
                
                // Rumble Haptic (Pattern: short, short, long rumble)
                haptic([20, 30, 20, 30, 80]); 

            }, 1200); // 1.2s delay before zoom

            // 4. Clean up and reveal app
            setTimeout(() => {
                bootScreen.style.display = 'none'; // Hide overlay
                
                // Try Auto-Connect after boot
                if(window.AppInventor) window.AppInventor.setWebViewString("AUTO_CONNECT");
            }, 1800); // 1.8s total duration
        };

        // --- CORE FUNCTIONS (Unchanged) ---
        
        window.setConnectionStatus = function(statusStr) {
            let status = (statusStr === "true" || statusStr === true);
            isConnected = status;
            
            const mainUI = document.getElementById('main-ui');
            const statusText = document.getElementById('main-status-text');
            const menuStatus = document.getElementById('menu-status');

            if (status) {
                // ONLINE
                menuStatus.innerText = "Connected"; menuStatus.className = "text-green-400 font-bold";
                statusText.innerText = "SYSTEM ONLINE"; statusText.className = "text-green-400 text-xs tracking-[0.2em] font-bold";
                document.getElementById('btn-start').classList.remove('opacity-50');
                if(mainUI) mainUI.classList.remove('offline-ui');
            } else {
                // OFFLINE
                menuStatus.innerText = "Disconnected"; menuStatus.className = "text-red-400 font-bold animate-pulse";
                statusText.innerText = "SEARCHING SIGNAL..."; statusText.className = "text-red-500 text-xs tracking-[0.2em] font-bold animate-pulse";
                document.getElementById('btn-start').classList.add('opacity-50');
                if(mainUI) mainUI.classList.add('offline-ui');
                if(engineRunning) { engineRunning = false; updateEngineUI(); }
            }
        };

        window.updateStatusFromArduino = function(data) {
            if (!data) return;
            let cleanData = data.toString().trim().toUpperCase();
            lastPacketTime = Date.now();
            if(!isConnected) window.setConnectionStatus(true);

            if (cleanData.includes("ENGINE_ON")) {
                if (!engineRunning) { engineRunning = true; updateEngineUI(); }
            } 
            else if (cleanData.includes("ENGINE_OFF") || cleanData.includes("IGNITION_ON")) {
                if (engineRunning) { engineRunning = false; updateEngineUI(); }
            }
        };

        // --- ANIMATED ACTIONS ---

        function findBike() {
            if(!isConnected) return;
            haptic(40);
            
            if (window.AppInventor) window.AppInventor.setWebViewString("FIND");
            
            const bikeGlow = document.getElementById('bike-glow');
            const btn = document.getElementById('btn-find');
            
            bikeGlow.className = "absolute inset-0 rounded-full bg-yellow-400/30 blur-2xl transition-all duration-300";
            btn.classList.add('sonar-effect'); 
            
            setTimeout(() => {
                bikeGlow.className = "absolute inset-0 rounded-full bg-yellow-500/0 blur-3xl transition-all duration-500"; 
                btn.classList.remove('sonar-effect');
            }, 2000);
        }

        function toggleLock() {
            if(!isConnected) return;
            haptic(50);
            isLocked = !isLocked;
            
            if (window.AppInventor) window.AppInventor.setWebViewString(isLocked ? "LOCK" : "UNLOCK");
            
            const icon = document.getElementById('icon-lock');
            const sub = document.getElementById('sub-lock');
            const dot = document.getElementById('dot-lock');
            const btn = document.getElementById('btn-lock');
            
            if(isLocked) {
                icon.className = "fa-solid fa-lock";
                sub.innerText = "Controls Locked";
                dot.classList.replace('bg-green-500', 'bg-red-500');
                dot.classList.replace('shadow-[0_0_10px_#22c55e]', 'shadow-[0_0_10px_#ef4444]');
                
                btn.classList.add('lock-shake');
                setTimeout(()=> btn.classList.remove('lock-shake'), 500);
                
                document.getElementById('btn-start').style.opacity = '0.3';
                document.getElementById('btn-find').style.opacity = '0.3';
            } else {
                icon.className = "fa-solid fa-lock-open";
                sub.innerText = "System Unlocked";
                dot.classList.replace('bg-red-500', 'bg-green-500');
                dot.classList.replace('shadow-[0_0_10px_#ef4444]', 'shadow-[0_0_10px_#22c55e]');
                
                document.getElementById('btn-start').style.opacity = '1';
                document.getElementById('btn-find').style.opacity = '1';
            }
        }

        function toggleEngine() {
            if(!isConnected) return;
            if(isLocked) { 
                document.getElementById('main-ui').classList.add('lock-shake');
                setTimeout(()=>document.getElementById('main-ui').classList.remove('lock-shake'), 500);
                haptic(100);
                return; 
            }
            haptic(50);
            
            if (!engineRunning) {
                if (window.AppInventor) window.AppInventor.setWebViewString("START");
            } else {
                if (window.AppInventor) window.AppInventor.setWebViewString("STOP");
            }
        }

        function updateEngineUI() {
            const btn = document.getElementById('btn-start');
            const icon = document.getElementById('icon-start');
            const txt = document.getElementById('txt-start');
            const sub = document.getElementById('sub-start');

            if(engineRunning) {
                btn.classList.add('engine-running');
                icon.className = "w-12 h-12 rounded-full bg-green-500 flex items-center justify-center text-white text-xl shadow-lg shadow-green-500/50";
                txt.innerText = "KILL SWITCH";
                sub.innerText = "Engine Running";
                sub.className = "text-xs text-green-400 font-bold";
            } else {
                btn.classList.remove('engine-running');
                icon.className = "w-12 h-12 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 text-xl";
                txt.innerText = "Ignition";
                sub.innerText = "Start Sequence";
                sub.className = "text-xs text-gray-400";
            }
        }

        function triggerBluetooth() {
            if (window.AppInventor) window.AppInventor.setWebViewString("SCAN_BLUETOOTH");
        }

        // --- UTILS ---
        function haptic(pattern) { if(navigator.vibrate) navigator.vibrate(pattern); }
        const menuBtn = document.getElementById('menu-btn');
        const menu = document.getElementById('floating-menu');
        menuBtn.addEventListener('click', (e) => { e.stopPropagation(); haptic(30); menu.classList.toggle('hidden'); });
        document.addEventListener('click', (e) => { if (!menu.classList.contains('hidden') && !menu.contains(e.target) && !menuBtn.contains(e.target)) menu.classList.add('hidden'); });

        document.body.addEventListener('click', function(e) {
            let target = e.target.closest('.ripple-btn');
            if (target) {
                const circle = document.createElement("span");
                const d = Math.max(target.clientWidth, target.clientHeight);
                circle.style.width = circle.style.height = `${d}px`;
                circle.style.left = `${e.clientX - target.getBoundingClientRect().left - d/2}px`;
                circle.style.top = `${e.clientY - target.getBoundingClientRect().top - d/2}px`;
                circle.classList.add("ripple-effect");
                target.appendChild(circle);
                setTimeout(()=>circle.remove(), 600);
            }
        });

        setInterval(() => {
            if (isConnected && (Date.now() - lastPacketTime > 6000)) {
                window.setConnectionStatus(false);
            }
        }, 2000);
    </script>
</body>
</html>